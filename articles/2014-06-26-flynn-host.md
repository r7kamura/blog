---
title: Flynn Host
---

[flynn/flynn-host](https://github.com/flynn/flynn-host) という、
Flynnで使われているホスト管理用のサービスのコードを読んだ。

## flynn-hostによって何ができるようになるのか
端的に言うと、HTTPのAPI経由で複数のホストで複数のDockerコンテナを管理出来るようになる。
flynn-hostのデーモンを全てのホストに常駐させておくことで、
外部からHTTP経由でホストのクラスタを管理出来る。
flynn-hostの機能によってクラスタ内の1つのホストがリーダーとして選出されるが、
リーダーとなるホストはHTTP経由で次のようなAPIを提供する。

* クラスタ内のホスト一覧を返す
* クラスタに新規ホストを登録する
* 特定のホストにジョブを実行させる

リーダー以外のホストはジョブが追加されるのを待ち受けており、
ジョブの実行命令を受け取るとこれをDockerコンテナで実行するようになっている。
またジョブを実行するホストもHTTP経由で次のようなAPIを提供している。

* 実行中のジョブ一覧を返す
* 特定のジョブの情報を返す
* 特定のジョブを停止させる
* 特定のジョブから発生するイベントを購読する

## ホストはどのように管理されるのか
flynn-hostクラスタ配下の各ホストでflynn-host、discoverd、etcdの3つのサービスを動作させておくことで、
各サービスが次のように協調し、flynn-hostにより自動的に選出されたリーダーが他のホストを管理してくれる。

* etcdが他のホストのetcdと情報を共有する
* discoverdがetcdを監視する
* flynn-hostがdiscoverdを監視する

## リーダーはどのように選出されるのか
これはまだ読んでいないので理解していない。
etcdで管理している各ノード(=ホスト情報が保存されているkey-valueの組)がインデックスという値を持っており、
この値を元にしてリーダーを1つに決めているというように予想を立てている。
