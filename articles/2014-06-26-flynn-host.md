---
title: Flynn Host
---

[flynn/flynn-host](https://github.com/flynn/flynn-host) という、
Flynnで使われているホスト管理用のサービスのコードを読んだ。

## flynn-hostによって何ができるようになるのか
端的に言うと、HTTPのAPI経由で複数のホストで複数のDockerコンテナを管理出来るようになる。
flynn-hostのデーモンを全てのホストに常駐させておくことで、
外部からHTTP経由でホストのクラスタを管理出来る。
flynn-hostの機能によってクラスタ内の1つのホストがリーダーとして選出されるが、
リーダーとなるホストはHTTP経由で次のようなAPIを提供する。

* クラスタ内のホスト一覧を返す
* クラスタに新規ホストを登録する
* 特定のホストにジョブを実行させる

リーダー以外のホストはジョブが登録されるのを待ち受けており、
ジョブの実行命令を受け取るとこれをDockerコンテナで実行するようになっている。
またジョブを実行するホストもHTTP経由で次のようなAPIを提供している。

* 実行中のジョブ一覧を返す
* 特定のジョブの情報を返す
* 特定のジョブを停止させる
* 特定のジョブから発生するイベントを購読する

## ジョブとは何か
「この処理をこのDockerのイメージを利用してコンテナ上で実行してくれー」
という命令を表現するデータ構造がジョブであり、
flynn-hostクラスタに対して何かの処理をしてほしいクライアント
(例えばUbuntuの上でこのRailsアプリを動かしてほしいとか)
はジョブというデータ構造でその旨を表現し、
flynn-hostのリーダーにHTTP経由でジョブを送信する。
ちなみにジョブには、
Hostname, Memory, Env, Entrypoint, Entrypoint, Imageなど、
Dockerコンテナの用意と実行に必要な様々なデータを設定として渡すことができる。

## ホストはどのように管理されるのか
flynn-hostクラスタ配下の各ホストでflynn-host、discoverd、etcdの3つのサービスを動作させておくことで、
各サービスが次のように協調し、flynn-hostにより自動的に選出されたリーダーが他のホストを管理してくれる。

* etcdが他のホストのetcdと情報を共有する
* discoverdがetcdを監視する
* flynn-hostがdiscoverdを監視する
