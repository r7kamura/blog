---
title: Flynn Host
---

[flynn/flynn-host](https://github.com/flynn/flynn-host) という、
Flynnで使われているホスト管理用のサービスのコードを読んだ。

## コードを理解するとはどういうことか
これまで [discoverd](http://r7kamura.github.io/2014/06/24/discoverd.html) や
[etcd](http://r7kamura.github.io/2014/02/26/etcd.html) などGolangのコードを粛々と読んできた訳だけれど、
コードを理解するというのは即ち「どういう利益を得るためにこのコードが書かれたのか」
を理解することだと捉えてみている。
例えば今回読んだflynn-hostであれば
「クラスタの中でもリーダーになるノードのみに処理を行わせたいからこういうコードが書かれているのだな」
と想像出来るようになったところで全体像や背景が見通せるようになり、ようやく腑に落ちた気持ちになった。
逆に考えると、それによってどういう利益を得たいのかがすぐ伝わるコード = 自分に理解しやすいコードということになる。

## flynn-hostによって何ができるようになるのか
端的に言うと、HTTPのAPI経由で複数のホストで複数のDockerコンテナを管理出来るようになる。
flynn-hostのデーモンを全てのホストに常駐させておくことで、
外部からHTTP経由でホストのクラスタを管理出来る。
flynn-hostの機能によってクラスタ内の1つのホストがリーダーとして選出されるが、
リーダーとなるホストはHTTP経由で次のようなAPIを提供する。

* クラスタ内のホスト一覧を返す
* クラスタに新規ホストを登録する
* 特定のホストにジョブを実行させる

リーダー以外のホストはジョブが追加されるのを待ち受けており、
ジョブの実行命令を受け取るとこれをDockerコンテナで実行するようになっている。
またジョブを実行するホストもHTTP経由で次のようなAPIを提供している。

* 実行中のジョブ一覧を返す
* 特定のジョブの情報を返す
* 特定のジョブを停止させる
* 特定のジョブから発生するイベントを購読する

## ホストはどのように管理されるのか
flynn-hostクラスタ配下の各ホストではflynn-host、discoverd、etcdの3つを動作させておく。
上手くいけば各サービスは次のように連携して動作する。

* etcdが他のホストのetcdと情報を共有する
* discoverdがetcdを監視する
* flynn-hostがdiscoverdを監視する

いずれかのホストがリーダーとして選出される。

## リーダーはどのように選出されるのか
TODO.

## その他
TODO.
